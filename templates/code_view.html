{% extends "project_base.html" %}


{% block p_head %}
  <script type="text/javascript" src="/js/showdown.js"></script>
  <script type="text/javascript" src="/js/preview.js"></script>
{% endblock %}


{% block breadcrumbs %}<li><a href="/{{project.key.integer_id()}}/code">Source code</a></li><li class="active">{{code.name | truncate(40, True)}}</li>{% endblock %}


{% block p_content %}
 
<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">
      <small><span class="glyphicon glyphicon-eye-{% if code.is_open_p() %}open{% else %}close{% endif %}"
		   title="This source-code discussion is {% if not code.is_open_p() %}not {% endif %}publicly visible."></span></small>
      {{code.name}}</h3>
  </div>
  <div class="panel-body">
    {% if user and project.user_is_author(user) %}
    <form method="post" role="form"
	  onsubmit="return confirm('Are you sure you want to make this source-code discussion {% if code.is_open_p() %}not {% endif %}publicly visible?');">
      <button class="btn btn-sm btn-default pull-right" title="This source-code discussion is {% if not code.is_open_p() %}not {% endif %}publicly visible. Click to toggle" 
	      type="submit">
	<span class="glyphicon glyphicon-eye-{% if code.is_open_p() %}open{% else %}close{% endif %}"></span></button>
      <input type="hidden" name="action" value="toggle_visibility" />
    </form>
    {% endif %}
    {{code.description | md | safe}}
    <p class="text-muted pull-right">Last comment: {{code.last_updated.strftime("%d %b %Y")}}</p>
    <a href="{{code.link}}">External link</a>
  </div>
</div>

<h3 class="page-header">Comments <span class="badge">{{code.get_number_of_comments()}}</span></h3>

<div class="list-group">
  {% for c in comments %}
  <div class="list-group-item">
    {{c.comment | md | safe}}
    <p class="text-muted pull-right">{{c.date.strftime("%d %b %Y")}}</p>
    <ul class="nav nav-pills">
      <li><a href="/{{c.author.get().username}}"><img src="{{c.author.get().get_profile_image(20)}}"/> {{c.author.get().username.capitalize()}}</a></li>
    </ul>
  </div>
  {% endfor %}
</div>

{% if user and project.user_is_author(user) %}
<form method="post" role="form">
  <div class="form-group{% if error_message %} has-error{% endif %}">
    <label for="commentText">Your comment</label>
    <textarea name="comment" id="commentText" class="form-control" rows="10"
	      onKeyUp="Preview('commentText','previewArea');">{{comment_value}}</textarea>
  </div>
  <button type="submit" class="btn btn-success">Comment</button>
  <input type="hidden" name="action" value="new_comment" />
  <p class="text-danger">{{error_message}}</p>
  <div class="help-block">
    Click <a href="/static/edit_help.html" target="_blank">here</a> to view some editing help (opens in a new window).
  </div>
</form>

<div>This is a preview of how the page will be renderer when you post it. It may not be 100&#37; accurate but it should be close.</div>
<div class="panel panel-default">
  <div class="panel-body" id="previewArea"><em>Start typing above to see the preview here.</em></div>
</div>
{% endif %}

{% endblock %}
